<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ReconPro Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script>
      // Optionally, add JavaScript for client-side filtering or refresh.
    </script>
  </head>
  <body>
    <div class="header">
      <h1>ReconPro Dashboard</h1>
      <form action="/" method="get" id="filterForm">
        <label for="method">Method:</label>
        <select name="method" id="method">
          <option value="" {% if filter.method == "" %}selected{% endif %}>All</option>
          <option value="GET" {% if filter.method == "GET" %}selected{% endif %}>GET</option>
          <option value="POST" {% if filter.method == "POST" %}selected{% endif %}>POST</option>
        </select>
        <label for="start_date">Start Date:</label>
        <input type="date" name="start_date" id="start_date" value="{{ filter.start_date }}">
        <label for="end_date">End Date:</label>
        <input type="date" name="end_date" id="end_date" value="{{ filter.end_date }}">
        <button type="submit" class="btn">Filter</button>
      </form>
      <button id="scanBtn" class="btn">Trigger New Scan</button>
      <a href="/charts" class="btn">View Charts</a>
    </div>
    <p>Last updated: {{ timestamp }}</p>
    <div id="status">Connecting to real‑time updates...</div>
    <h2>Vulnerabilities</h2>
    {% if vulnerabilities %}
      <table>
        <tr>
          <th>ID</th>
          <th>URL</th>
          <th>Parameter</th>
          <th>Payload</th>
          <th>Method</th>
          <th>Similarity</th>
          <th>GF Matches</th>
          <th>Nuclei Output</th>
          <th>Timestamp</th>
        </tr>
        {% for vuln in vulnerabilities %}
          <tr>
            <td>{{ vuln[0] }}</td>
            <td>{{ vuln[1] }}</td>
            <td>{{ vuln[2] }}</td>
            <td>{{ vuln[3] }}</td>
            <td>{{ vuln[4] }}</td>
            <td>{{ "%.2f"|format(vuln[5]) }}</td>
            <td>{{ vuln[6] }}</td>
            <td>{{ vuln[7] }}</td>
            <td>{{ vuln[8] }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No vulnerabilities found.</p>
    {% endif %}
    <script>
      // Establish a WebSocket connection for real‑time updates.
      const ws = new WebSocket("ws://" + window.location.host + "/ws");
      const statusDiv = document.getElementById("status");
      
      ws.onopen = function(event) {
        statusDiv.innerText = "Connected to real‑time updates.";
      };

      ws.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          if(data.event === "status_update") {
            statusDiv.innerText = `Last update: ${data.timestamp} | Total: ${data.vulnerability_count} | GET: ${data.GET_count} | POST: ${data.POST_count}`;
          } else if(data.event === "scan_triggered") {
            statusDiv.innerText = data.message + " (" + data.timestamp + ")";
          }
        } catch(e) {
          console.log("Message:", event.data);
        }
      };

      ws.onclose = function(event) {
        statusDiv.innerText = "Disconnected from real‑time updates.";
      };

      // Handle the scan trigger button.
      document.getElementById("scanBtn").addEventListener("click", function() {
        fetch("/scan", { method: "POST" })
          .then(response => response.json())
          .then(data => {
            statusDiv.innerText = data.message;
          })
          .catch(err => {
            statusDiv.innerText = "Error triggering scan: " + err;
          });
      });
    </script>
  </body>
</html>
